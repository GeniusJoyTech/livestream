<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Viewer DinÃ¢mico</title>
  <style>
    #remoteVideo {
      width: 80%;
      border: 2px solid black;
      margin-top: 10px;
      position: relative;
    }

    .controls {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h2>ğŸ‘€ Assistindo a transmissÃ£o</h2>

  <div class="controls">
    <button id="connectButton">ğŸ”Œ Conectar</button>
    <button id="disconnectButton" disabled>âŒ Desconectar</button>
    <button id="reconnectButton" disabled>ğŸ”„ Reconectar</button>
    </div>

  <label for="broadcasterSelect">Escolha um broadcaster:</label>
  <select id="broadcasterSelect"></select>
  <br>
  <label for="monitorSelect">Escolha um monitor:</label>
  <select id="monitorSelect">
    <option value="1">Monitor 1</option>
    <option value="2">Monitor 2</option>
  </select>
 <div id="controls">
    <button id="watchButton">â–¶ï¸ Assistir</button>
    <button id="fullscreenButton">ğŸ–µ Tela cheia</button>
  </div>

  <div style="position: relative; display: inline-block;">
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <script>
    const connectButton = document.getElementById('connectButton');
    const watchButton = document.getElementById('watchButton');
    const disconnectButton = document.getElementById('disconnectButton');
    const reconnectButton = document.getElementById('reconnectButton');
    const fullscreenButton = document.getElementById('fullscreenButton');

    const broadcasterSelect = document.getElementById('broadcasterSelect');
    const monitorSelect = document.getElementById('monitorSelect');
    const remoteVideo = document.getElementById('remoteVideo');

    let socket;
    let peers = new Map();
    let selectedBroadcasterId = null;
    let selectedMonitorNumber = null;
    let broadcasters = [];

    // ============================
    // Conectar WebSocket
    // ============================
    async function connect() {
      connectButton.disabled = true;
      connectButton.textContent = 'Conectando...';

      socket = new WebSocket(`ws://${location.host}`);

      socket.onopen = () => {
        console.log('WebSocket conectado');
        socket.send(JSON.stringify({ type: 'viewer' }));
        connectButton.style.display = 'none';
        disconnectButton.disabled = false;
        reconnectButton.disabled = true;
      };

      socket.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        switch (message.type) {
          case 'broadcaster-list':
            broadcasters = message.broadcasters || [];
            updateSelect();
            break;
          case 'new-broadcaster':
            if (!broadcasters.some(b => b.id === message.broadcasterId)) {
              broadcasters.push({ id: message.broadcasterId, name: message.broadcaster_name || `Broadcaster ${message.broadcasterId.slice(0,6)}` });
              updateSelect();
            }
            break;
          case 'broadcaster-left':
            broadcasters = broadcasters.filter(b => b.id !== message.broadcasterId);
            updateSelect();
            if (selectedBroadcasterId === message.broadcasterId) {
              remoteVideo.srcObject = null;
              alert(`âŒ O broadcaster saiu.`);
              selectedBroadcasterId = null;
              selectedMonitorNumber = null;
            }
            break;
          case 'offer':
            const pc = createPeerConnection(message.senderId, message.monitor_number);
            peers.set(message.senderId, pc);
            await pc.setRemoteDescription(new RTCSessionDescription(message.sdp));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            socket.send(JSON.stringify({ type: 'answer', sdp: pc.localDescription, targetId: message.senderId }));
            break;
          case 'candidate':
            const candidatePc = peers.get(message.senderId);
            if (candidatePc) await candidatePc.addIceCandidate(new RTCIceCandidate(message.candidate));
            break;
        }
      };

      socket.onclose = () => {
        console.log('WebSocket desconectado');
        disconnectButton.disabled = true;
        reconnectButton.disabled = false;
      };
    }

    connectButton.onclick = connect;

    // ============================
    // Assistir
    // ============================
    watchButton.onclick = () => {
      selectedBroadcasterId = broadcasterSelect.value;
      selectedMonitorNumber = monitorSelect.value;
      if (!selectedBroadcasterId || !selectedMonitorNumber || !socket || socket.readyState !== WebSocket.OPEN) return;

      socket.send(JSON.stringify({
        type: 'watch',
        targetId: selectedBroadcasterId,
        monitor_number: selectedMonitorNumber
      }));
    };

    // ============================
    // Desconectar
    // ============================
    disconnectButton.onclick = () => {
      peers.forEach(pc => pc.close());
      peers.clear();
      if (socket) socket.close();
      remoteVideo.srcObject = null;
      disconnectButton.disabled = true;
      reconnectButton.disabled = false;
      console.log('Desconectado');
    };

    // ============================
    // Reconectar
    // ============================
    reconnectButton.onclick = () => {
      connect();
    };

    // ============================
    // Tela cheia
    // ============================
    fullscreenButton.onclick = () => {
      if (remoteVideo.requestFullscreen) remoteVideo.requestFullscreen();
      else if (remoteVideo.webkitRequestFullscreen) remoteVideo.webkitRequestFullscreen();
    };

    // ============================
    // Atualiza select de broadcasters
    // ============================
    function updateSelect() {
      broadcasterSelect.innerHTML = '';
      if (broadcasters.length === 0) {
        const opt = document.createElement('option');
        opt.textContent = 'Nenhum broadcaster disponÃ­vel';
        opt.disabled = true;
        broadcasterSelect.appendChild(opt);
        return;
      }
      broadcasters.forEach(b => {
        const option = document.createElement('option');
        option.value = b.id;
        option.textContent = b.name;
        broadcasterSelect.appendChild(option);
      });
    }

    // ============================
    // Cria conexÃ£o WebRTC
    // ============================
    function createPeerConnection(id, monitor_number) {
      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

      pc.onicecandidate = (event) => {
        if (event.candidate && socket.readyState === WebSocket.OPEN) {
          socket.send(JSON.stringify({ type: 'candidate', candidate: event.candidate, targetId: id }));
        }
      };

      pc.ontrack = (event) => {
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
          remoteVideo.play().catch(e => console.warn('Erro ao iniciar play:', e));
        }
      };

      return pc;
    }
  </script>
</body>
</html>
